@page "/dashboard"
@attribute [Authorize]
@using System.Security.Claims
@using Jarvis.Web.Models
@using Jarvis.Web.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject ReviewsClient ReviewsClient
@inject SubmissionsClient SubmissionsClient
@inject VenueApiService VenueService
@inject NavigationManager Nav

<div class="container-fluid py-4" style="max-width: 1400px;">
    @if (isLoading)
    {
        <div class="d-flex flex-column align-items-center justify-content-center min-vh-50">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted fw-medium">Loading your workspace...</p>
        </div>
    }
    else
    {
        <!-- GREETING SECTION -->
        <div class="mb-5">
            <h2 class="fw-bold text-dark">Welcome back, <span class="text-primary">@userName</span>!</h2>
            <p class="text-muted">Here is what’s happening in your academic circle today.</p>
        </div>

        @if (userRole == "Reviewer")
        {
            <!-- REVIEWER DASHBOARD (Modern Cards) -->
            <div class="row g-4 mb-5">
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm hover-card bg-warning-subtle">
                        <div class="card-body p-4 d-flex align-items-center justify-content-between" @onclick='() => Nav.NavigateTo("/my-reviews")' style="cursor:pointer">
                            <div>
                                <h6 class="text-warning-emphasis text-uppercase fw-bold ls-1 mb-1">Invitations</h6>
                                <h1 class="display-4 fw-bold mb-0 text-dark">@invitationCount</h1>
                                <small class="text-muted">Pending Response</small>
                            </div>
                            <i class="bi bi-envelope-paper fs-1 text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm hover-card bg-primary-subtle">
                        <div class="card-body p-4 d-flex align-items-center justify-content-between" @onclick='() => Nav.NavigateTo("/my-reviews")' style="cursor:pointer">
                            <div>
                                <h6 class="text-primary-emphasis text-uppercase fw-bold ls-1 mb-1">Active Reviews</h6>
                                <h1 class="display-4 fw-bold mb-0 text-dark">@pendingReviewCount</h1>
                                <small class="text-muted">In Progress</small>
                            </div>
                            <i class="bi bi-pencil-square fs-1 text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (userRole == "EditorInChief" || userRole == "TrackChair" || userRole == "Admin")
        {
            <!-- EDITOR DASHBOARD -->
            <EditorDashboard SearchTerm="@searchTerm" FilterStatus="@filterType" />
        }
        else
        {
            <!-- AUTHOR DASHBOARD -->
            <!-- 1. MY SUBMISSIONS (Modern Timeline/List) -->
            @if (myActiveConferences.Any())
            {
                <div class="d-flex align-items-center mb-3">
                    <h5 class="fw-bold mb-0"><i class="bi bi-folder2-open me-2 text-primary"></i>My Submissions</h5>
                </div>
                <div class="row g-3 mb-5">
                    @foreach (var item in myActiveConferences)
                    {
                        <div class="col-md-6 col-xl-4">
                            <div class="card border-0 shadow-sm h-100 submission-card">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <span class="badge @GetStatusClass(item.Status) px-3 py-2 rounded-pill">@item.Status</span>
                                        <small class="text-muted"><i class="bi bi-clock me-1"></i>@item.SubmissionDate.ToString("MMM dd")</small>
                                    </div>
                                    <h6 class="fw-bold text-dark mb-2 text-truncate-2" title="@item.SubmissionTitle">@item.SubmissionTitle</h6>
                                    <p class="text-muted small mb-3"><i class="bi bi-geo-alt me-1"></i>@item.VenueName</p>
                                    <button class="btn btn-outline-primary btn-sm w-100 rounded-pill" @onclick='() => Nav.NavigateTo($"/submissions/{item.SubmissionId}")'>
                                        View Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

            <!-- 2. AVAILABLE VENUES (Modern Search & List) -->
            <div class="d-flex justify-content-between align-items-end mb-4">
                <div>
                    <h4 class="fw-bold mb-1">Open Calls for Papers</h4>
                    <p class="text-muted mb-0 small">Explore journals and conferences accepting submissions.</p>
                </div>
            </div>

            <!-- Search Bar Area -->
            <div class="card border-0 shadow-sm mb-4 p-2">
                <div class="d-flex gap-2">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-0 py-2 shadow-none"
                               placeholder="Search by name, acronym or topic..."
                               @bind="searchTerm"
                               @bind:event="oninput" />
                    </div>
                    <select class="form-select border-0 bg-light py-2" style="max-width: 200px;" @bind="filterType">
                        <option value="">All Types</option>
                        <option value="Conference">Conferences</option>
                        <option value="Journal">Journals</option>
                    </select>
                </div>
            </div>

            <!-- Modern Venue List (Cards instead of Table) -->
            <div class="d-flex flex-column gap-3">
                @if (FilteredVenues.Any())
                {
                    @foreach (var venue in FilteredVenues)
                    {
                        <div class="card border-0 shadow-sm venue-card transition-all">
                            <div class="card-body p-4">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">

                                    <!-- Sol Taraf: İsim ve Etiketler -->
                                    <div class="d-flex align-items-center gap-3 flex-grow-1" style="cursor: pointer;" @onclick="() => ToggleDetails(venue)">
                                        <div class="venue-icon bg-light text-primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 50px; height: 50px;">
                                            <i class="bi @(venue.Type == "Journal" ? "bi-journal-richtext" : "bi-people-fill") fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="d-flex align-items-center gap-2 mb-1">
                                                <h6 class="fw-bold text-dark mb-0 hover-underline">@venue.Name</h6>
                                                <span class="badge bg-light text-secondary border">@venue.Acronym</span>
                                            </div>
                                            <div class="text-muted small">
                                                <span class="me-3"><i class="bi bi-tag me-1"></i>@venue.Type</span>
                                                @if (!string.IsNullOrEmpty(venue.Keywords))
                                                {
                                                    <span><i class="bi bi-hash me-1"></i>@venue.Keywords.Split(',').FirstOrDefault()...</span>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sağ Taraf: Aksiyonlar -->
                                    <div class="d-flex align-items-center gap-2">
                                        <button class="btn btn-light btn-sm text-muted rounded-pill px-3" @onclick="() => ToggleDetails(venue)">
                                            @(venue.IsExpanded ? "Hide Details" : "View Details") <i class="bi @(venue.IsExpanded ? "bi-chevron-up" : "bi-chevron-down") ms-1"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm rounded-pill px-4 fw-bold shadow-sm" @onclick="@(() => Nav.NavigateTo($"/submit/{venue.Id}"))">
                                            Submit Paper
                                        </button>
                                    </div>
                                </div>

                                <!-- EXPANDABLE DETAILS AREA -->
                                @if (venue.IsExpanded)
                                {
                                    <div class="mt-4 pt-3 border-top fade-in">
                                        <div class="row g-4">
                                            <div class="col-md-8">
                                                <h6 class="text-uppercase text-muted small fw-bold mb-2 ls-1">Aim & Scope</h6>
                                                <p class="text-secondary mb-0 small lh-lg">
                                                    @(string.IsNullOrEmpty(venue.Description) ? "No detailed scope description provided." : venue.Description)
                                                </p>
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="text-uppercase text-muted small fw-bold mb-2 ls-1">Available Tracks</h6>
                                                @if (venue.Tracks.Any())
                                                {
                                                    <div class="d-flex flex-wrap gap-2">
                                                        @foreach (var track in venue.Tracks)
                                                        {
                                                            <span class="badge bg-light text-dark border fw-normal py-2 px-3">@track</span>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">General Track</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5">
                        <img src="https://cdn-icons-png.flaticon.com/512/7486/7486754.png" width="80" class="mb-3 opacity-50 grayscale" />
                        <h5 class="text-muted fw-bold">No venues found</h5>
                        <p class="text-muted small">Try adjusting your search terms or filters.</p>
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    /* Custom Styles for Modern Dashboard */
    .ls-1 {
        letter-spacing: 1px;
    }

    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        transition: all 0.3s ease;
    }

    .submission-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

        .submission-card:hover {
            border-left-color: var(--bs-primary);
            transform: translateX(5px);
        }

    .venue-card {
        transition: all 0.2s ease;
    }

        .venue-card:hover {
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.08) !important;
        }

    .hover-underline:hover {
        text-decoration: underline;
    }

    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .grayscale {
        filter: grayscale(100%);
    }
</style>

@code {
    private string userRole = "";
    private string userName = "";
    private bool isLoading = true;

    // Reviewer Data
    private int invitationCount = 0;
    private int pendingReviewCount = 0;

    // Author Data
    private List<VenueDto> allVenues = new();
    private List<MyConferenceViewModel> myActiveConferences = new();

    // Search & Filter
    private string searchTerm = "";
    private string filterType = "";

    // Filtrelenmiş Liste
    private IEnumerable<VenueDto> FilteredVenues => allVenues
        .Where(v =>
            (string.IsNullOrEmpty(searchTerm) ||
             v.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             v.Acronym.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             (v.Keywords != null && v.Keywords.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))) &&
            (string.IsNullOrEmpty(filterType) || v.Type == filterType)
        );

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            userRole = user.Claims.FirstOrDefault(c => c.Type.Contains("role"))?.Value ?? "User";
            userName = user.Identity.Name ?? "Scholar";

            if (userRole == "Reviewer")
            {
                try
                {
                    var reviews = await ReviewsClient.GetMyAssignmentsAsync();
                    invitationCount = reviews.Count(r => r.Status == "Invited");
                    pendingReviewCount = reviews.Count(r => r.Status == "Accepted");
                }
                catch { }
            }
            else
            {
                try
                {
                    // Paralel Veri Çekimi
                    var venuesTask = VenueService.GetAllVenuesAsync();
                    var submissionsTask = SubmissionsClient.GetMySubmissionsAsync();

                    await Task.WhenAll(venuesTask, submissionsTask);

                    allVenues = venuesTask.Result;
                    var mySubmissions = submissionsTask.Result;

                    myActiveConferences = mySubmissions.Select(s => new MyConferenceViewModel
                    {
                        SubmissionId = s.Id,
                        SubmissionTitle = s.Title,
                        Status = s.Status,
                        SubmissionDate = s.CreatedAt,
                        VenueName = allVenues.FirstOrDefault(v => v.Id == s.VenueId)?.Name ?? "Unknown Venue"
                    }).ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error: {ex.Message}");
                }
            }
        }
        isLoading = false;
    }

    private void ToggleDetails(VenueDto venue)
    {
        venue.IsExpanded = !venue.IsExpanded;
    }

    private string GetStatusClass(string status) => status switch
    {
        "Draft" => "bg-secondary bg-opacity-10 text-secondary",
        "Submitted" => "bg-info bg-opacity-10 text-info",
        "UnderReview" => "bg-warning bg-opacity-10 text-warning",
        "Accepted" => "bg-success bg-opacity-10 text-success",
        "Rejected" => "bg-danger bg-opacity-10 text-danger",
        _ => "bg-light text-dark"
    };

    public class MyConferenceViewModel
    {
        public Guid SubmissionId { get; set; }
        public string VenueName { get; set; } = "";
        public string SubmissionTitle { get; set; } = "";
        public string Status { get; set; } = "";
        public DateTime SubmissionDate { get; set; }
    }
}