@page "/dashboard"
@attribute [Authorize]
@using System.Security.Claims
@using Jarvis.Web.Models
@using Jarvis.Web.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject ReviewsClient ReviewsClient
@inject NavigationManager Nav

<div class="container-fluid py-4">
    @if (isLoading)
    {
        <div class="text-center p-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        @if (userRole == "EditorInChief" || userRole == "TrackChair" || userRole == "Admin")
        {
            <div class="alert alert-primary mb-4 border-0 shadow-sm">
                <i class="bi bi-shield-lock-fill me-2"></i> You are logged in as <strong>@userRole</strong>
            </div>
            <EditorDashboard />
        }
        else if (userRole == "Reviewer")
        {
            <div class="row g-4">
                <div class="col-12">
                    <h3 class="fw-bold">Reviewer Dashboard</h3>
                    <p class="text-muted">Welcome back, Dr. @userName</p>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 shadow-sm bg-warning bg-opacity-10 h-100 p-4" style="cursor:pointer" @onclick='() => Nav.NavigateTo("/my-reviews")'>
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-warning text-uppercase fw-bold">New Invitations</h6>
                                <h2 class="fw-bold">@invitationCount</h2>
                                <p class="mb-0 small text-muted">Awaiting your response</p>
                            </div>
                            <i class="bi bi-envelope-paper fs-1 text-warning"></i>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 shadow-sm bg-primary bg-opacity-10 h-100 p-4" style="cursor:pointer" @onclick='() => Nav.NavigateTo("/my-reviews")'>
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-primary text-uppercase fw-bold">Pending Reviews</h6>
                                <h2 class="fw-bold">@pendingReviewCount</h2>
                                <p class="mb-0 small text-muted">Accepted but not submitted</p>
                            </div>
                            <i class="bi bi-pencil-square fs-1 text-primary"></i>
                        </div>
                    </div>
                </div>

                <div class="col-12 mt-4">
                    <button class="btn btn-primary btn-lg px-5 shadow-sm" @onclick='() => Nav.NavigateTo("/my-reviews")'>
                        Go to My Reviews List <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        }
        else
        {
            <div class="mb-4">
                <h3 class="fw-bold">Welcome, Author!</h3>
                <p class="text-muted">Select a venue below to start a new academic submission.</p>
            </div>
            <Jarvis.Web.Components.Pages.Venues.VenueList />
        }
    }
</div>

@code {
    private string userRole = "";
    private string userName = "";
    private bool isLoading = true;
    private int invitationCount = 0;
    private int pendingReviewCount = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            userRole = user.Claims.FirstOrDefault(c => c.Type.Contains("role"))?.Value ?? "User";
            userName = user.Identity.Name ?? "Scholar";

            if (userRole == "Reviewer")
            {
                var reviews = await ReviewsClient.GetMyAssignmentsAsync();
                invitationCount = reviews.Count(r => r.Status == "Invited");
                pendingReviewCount = reviews.Count(r => r.Status == "Accepted");
            }
        }

        isLoading = false;
    }
}