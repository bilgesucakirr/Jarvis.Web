@page "/submissions/{SubmissionId:guid}/assign"
@attribute [Authorize(Roles = "EditorInChief,TrackChair,Admin")]
@using Jarvis.Web.Models
@using Jarvis.Web.Services
@inject UsersClient UsersClient
@inject SubmissionsClient SubmissionsClient
@inject HttpClient Http
@inject NavigationManager Navigation

@rendermode InteractiveServer

<div class="container py-4">
    <button class="btn btn-link p-0 mb-3 text-decoration-none" @onclick='() => Navigation.NavigateTo("/dashboard")'>
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </button>
    <h3>Assign Reviewer</h3>

    @if (submissionTitle != null)
    {
        <h5 class="text-primary">@submissionTitle</h5>
    }

    <div class="row mt-4">
        <div class="col-md-5">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold">Find Reviewers</div>
                <div class="card-body">
                    <!-- 3. Gereksinim: İlgi Alanı Dropdown -->
                    <div class="mb-2">
                        <label class="form-label small text-muted">Filter by Interest</label>
                        <select class="form-select" @bind="selectedInterest">
                            <option value="">All Interests</option>
                            <option value="AI">Artificial Intelligence</option>
                            <option value="Machine Learning">Machine Learning</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Security">Security</option>
                        </select>
                    </div>

                    <div class="input-group mb-3">
                        <input class="form-control" @bind="keyword" placeholder="Search by Name" @onkeyup="@(e => { if (e.Key == "Enter") Search(); })" />
                        <button class="btn btn-secondary" @onclick="Search"><i class="bi bi-search"></i></button>
                    </div>

                    @if (reviewers.Any())
                    {
                        <div class="list-group">
                            @foreach (var r in reviewers)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectReviewer(r)">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@r.FullName</h6>
                                    </div>
                                    <small class="text-muted">@r.Interests</small>
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold">Invitation Details</div>
                <div class="card-body">
                    @if (selectedReviewer != null)
                    {
                        <div class="alert alert-primary">
                            <strong>Selected Reviewer:</strong> @selectedReviewer.FullName <br />
                            <small>@selectedReviewer.Email</small>
                        </div>

                        <label class="form-label mt-3">Due Date</label>
                        <input type="date" class="form-control mb-4" @bind="dueDate" />

                        <button class="btn btn-success w-100" @onclick="SendInvitation">Send Invitation</button>
                    }
                    else
                    {
                        <div class="text-center p-5 text-muted">
                            <i class="bi bi-person-plus fs-1"></i>
                            <p class="mt-2">Select a reviewer from the left list.</p>
                        </div>
                    }

                    @if (msg != null)
                    {
                        <div class="alert alert-info mt-3">@msg</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid SubmissionId { get; set; }
    private string keyword = "";
    private string selectedInterest = ""; // 3. Gereksinim
    private List<ReviewerDto> reviewers = new();
    private ReviewerDto? selectedReviewer;
    private DateTime dueDate = DateTime.Today.AddDays(14);
    private string? msg;
    private string? submissionTitle;

    protected override async Task OnInitializedAsync()
    {
        var sub = await SubmissionsClient.GetSubmissionDetailAsync(SubmissionId);
        if (sub != null) submissionTitle = sub.Title;
    }

    private async Task Search()
    {
        // 3. Gereksinim: Dropdown ile seçilen interest'i gönder
        reviewers = await UsersClient.SearchReviewersAsync(keyword, selectedInterest);
    }

    private void SelectReviewer(ReviewerDto r)
    {
        selectedReviewer = r;
        msg = null;
    }

    private async Task SendInvitation()
    {
        try
        {
            var payload = new InviteReviewerModel
            {
                SubmissionId = SubmissionId,
                ReviewerUserId = Guid.Parse(selectedReviewer!.Id),
                ReviewerEmail = selectedReviewer.Email,
                SubmissionTitle = submissionTitle ?? "Academic Submission",
                DueDate = dueDate
            };

            var res = await Http.PostAsJsonAsync("https://localhost:7047/api/Assignments/invite", payload);

            if (res.IsSuccessStatusCode)
            {
                msg = "Invitation sent successfully!";
                selectedReviewer = null;
            }
            else
            {
                msg = "Error: " + await res.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            msg = ex.Message;
        }
    }
}