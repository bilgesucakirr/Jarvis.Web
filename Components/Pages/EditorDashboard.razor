@using Jarvis.Web.Models
@using Jarvis.Web.Services
@inject SubmissionsClient SubmissionsClient
@inject NavigationManager Nav

<div class="card border-0 shadow-sm rounded-4 mt-4">
    <div class="card-header bg-white py-4 border-0 d-flex justify-content-between align-items-center">
        <div>
            <h5 class="fw-bold mb-0">Submission Management</h5>
            <p class="text-muted small mb-0">Tracking all manuscripts for this venue</p>
        </div>
        <div class="d-flex gap-2">
            <!-- STATÜ FİLTRESİ EKLENDİ -->
            <select class="form-select form-select-sm" @bind="selectedStatusFilter" style="width: 200px;">
                <option value="">All Statuses</option>
                <option value="Submitted">Submitted (Waiting for Review)</option>
                <option value="UnderReview">Under Review</option>
                <option value="MinorRevisionRequired">Minor Revision</option>
                <option value="MajorRevisionRequired">Major Revision</option>
                <option value="CameraReadyRequested">Accepted (Awaiting Final File)</option>
                <option value="CameraReadySubmitted">Accepted (Final File Submitted)</option>
                <option value="Accepted">Accepted (Final Decision)</option>
                <option value="Rejected">Rejected</option>
            </select>
            <!-- Arama Inputu -->
            <div class="input-group input-group-sm" style="width: 250px;">
                <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control bg-light border-0" placeholder="Filter by title..." @bind="searchTerm" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-secondary small text-uppercase">
                <tr>
                    <th class="ps-4 py-3">Reference</th>
                    <th class="py-3">Title & Status</th>
                    <th class="py-3 text-center">Review Progress</th>
                    <th class="py-3">Date</th>
                    <th class="py-3 text-end pe-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (submissions == null)
                {
                    <tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                }
                else if (!FilteredSubmissions.Any())
                {
                    <tr><td colspan="5" class="text-center py-5 text-muted">No submissions found for this venue based on current filter.</td></tr>
                }
                else
                {
                    @foreach (var sub in FilteredSubmissions)
                    {
                        <tr>
                            <td class="ps-4">
                                <span class="badge bg-light text-dark border font-monospace">
                                    @(string.IsNullOrEmpty(sub.ReferenceNumber) ? "DRAFT" : sub.ReferenceNumber)
                                </span>
                            </td>
                            <td>
                                <div class="fw-bold text-dark mb-1">@sub.Title</div>
                                <span class="badge rounded-pill @GetStatusClass(sub.Status) fw-normal">@sub.Status</span>
                            </td>
                            <td class="text-center">
                                <div class="d-flex flex-column align-items-center" style="min-width: 150px;">
                                    <div class="progress w-100 bg-light mb-1" style="height: 6px;">
                                        <div class="progress-bar @GetProgressColor(sub)" role="progressbar"
                                             style="width: @GetProgressPercent(sub)%"></div>
                                    </div>
                                    <small class="text-muted" style="font-size: 0.7rem;">
                                        @sub.ReviewsCompletedCount / @sub.ReviewersAssignedCount Completed
                                    </small>
                                </div>
                            </td>
                            <td>
                                <div class="small text-dark">@sub.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</div>
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-sm btn-white border" @onclick='() => Nav.NavigateTo($"/submissions/{sub.Id}")' title="View Details">
                                        <i class="bi bi-eye-fill text-primary"></i>
                                    </button>
                                    @if (sub.Status != "Draft" && sub.Status != "Rejected" && sub.Status != "CameraReadySubmitted" && sub.Status != "Accepted")
                                    {
                                        <button class="btn btn-sm btn-white border" @onclick='() => Nav.NavigateTo($"/submissions/{sub.Id}/assign")' title="Assign Reviewers">
                                            <i class="bi bi-person-plus-fill text-dark"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    [Parameter] public Guid VenueId { get; set; }
    private List<SubmissionStatsModel>? submissions;
    private string searchTerm = "";

    // YENİ FİLTRE DEĞİŞKENİ
    private string selectedStatusFilter = "";

    private IEnumerable<SubmissionStatsModel> FilteredSubmissions =>
        submissions?.Where(s =>
            (string.IsNullOrEmpty(searchTerm) || s.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(selectedStatusFilter) || s.Status.Equals(selectedStatusFilter, StringComparison.OrdinalIgnoreCase))
        )
        ?? new List<SubmissionStatsModel>();

    protected override async Task OnParametersSetAsync()
    {
        submissions = null;
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            submissions = await SubmissionsClient.GetEditorSubmissionsAsync(VenueId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading filtered submissions: {ex.Message}");
        }
    }

    private int GetProgressPercent(SubmissionStatsModel s) => s.ReviewersAssignedCount == 0 ? 0 : (s.ReviewsCompletedCount * 100 / s.ReviewersAssignedCount);

    private string GetProgressColor(SubmissionStatsModel s)
    {
        if (s.ReviewersAssignedCount == 0) return "bg-secondary";
        var p = GetProgressPercent(s);
        if (p == 100) return "bg-success";
        if (p >= 50) return "bg-info";
        return "bg-warning";
    }

    private string GetStatusClass(string s) => s switch
    {
        "Submitted" => "bg-info-subtle text-info",
        "UnderReview" => "bg-primary-subtle text-primary",
        "Accepted" => "bg-success-subtle text-success",
        "CameraReadySubmitted" => "bg-success text-white",
        "MinorRevisionRequired" => "bg-warning-subtle text-warning",
        "MajorRevisionRequired" => "bg-primary-subtle text-primary",
        "CameraReadyRequested" => "bg-warning text-dark",
        "Rejected" => "bg-danger-subtle text-danger",
        _ => "bg-light text-dark"
    };
}