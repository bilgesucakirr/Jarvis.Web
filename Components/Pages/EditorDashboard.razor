@using Jarvis.Web.Models
@using Jarvis.Web.Services
@using System.Text
@inject SubmissionsClient SubmissionsClient
@inject NavigationManager Nav
@inject IJSRuntime JS

<!-- İstatistik Kartları (Filtreden etkilenmez, genel durumu gösterir) -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stats-card bg-white p-3 shadow-sm rounded-3 border-start border-4 border-primary">
            <div class="text-muted small text-uppercase fw-bold ls-1">Total Submissions</div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <h2 class="mb-0 fw-bold text-dark">@(submissions?.Count ?? 0)</h2>
                <div class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-file-earmark-text"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card bg-white p-3 shadow-sm rounded-3 border-start border-4 border-warning">
            <div class="text-muted small text-uppercase fw-bold ls-1">Pending Reviews</div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <h2 class="mb-0 fw-bold text-dark">@GetPendingCount()</h2>
                <div class="icon-circle bg-warning-subtle text-warning"><i class="bi bi-hourglass-split"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card bg-white p-3 shadow-sm rounded-3 border-start border-4 border-success">
            <div class="text-muted small text-uppercase fw-bold ls-1">Accepted</div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <h2 class="mb-0 fw-bold text-dark">@GetAcceptedCount()</h2>
                <div class="icon-circle bg-success-subtle text-success"><i class="bi bi-check-lg"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 rounded-3">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-bottom-0">
        <div>
            <h5 class="mb-0 fw-bold text-dark">Submission Management</h5>
            <p class="text-muted small mb-0">Manage and track all academic submissions</p>
        </div>
        <div>
            <!-- Butonlar İşlevsel Hale Getirildi -->
            <button class="btn btn-light border btn-sm text-muted me-2" @onclick="ClearFilters">
                <i class="bi bi-x-circle"></i> Clear Filters
            </button>
            <button class="btn btn-primary btn-sm" @onclick="ExportToCsv">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 custom-table">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4 text-secondary text-uppercase small fw-bold">Ref No</th>
                    <th class="text-secondary text-uppercase small fw-bold" style="width: 40%;">Title / Status</th>
                    <th class="text-center text-secondary text-uppercase small fw-bold">Review Progress</th>
                    <th class="text-secondary text-uppercase small fw-bold">Submitted Date</th>
                    <th class="text-end pe-4 text-secondary text-uppercase small fw-bold">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredSubmissions == null)
                {
                    <tr><td colspan="5" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>
                }
                else if (!FilteredSubmissions.Any())
                {
                    <tr><td colspan="5" class="text-center p-5 text-muted">No submissions found matching criteria.</td></tr>
                }
                else
                {
                    @foreach (var sub in FilteredSubmissions)
                    {
                        <tr>
                            <td class="ps-4">
                                <span class="font-monospace text-primary bg-primary-subtle px-2 py-1 rounded small">
                                    @(string.IsNullOrEmpty(sub.ReferenceNumber) ? "DRAFT" : sub.ReferenceNumber)
                                </span>
                            </td>
                            <td>
                                <div class="fw-bold text-dark mb-1">@sub.Title</div>
                                <span class="badge rounded-pill @GetStatusBadgeClass(sub.Status) px-3">
                                    @sub.Status
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="d-flex flex-column align-items-center">
                                    <div class="progress w-75" style="height: 6px;">
                                        <div class="progress-bar @GetProgressBarColor(sub.ReviewersAssignedCount, sub.ReviewsCompletedCount)"
                                             role="progressbar"
                                             style="width: @GetProgressPercentage(sub.ReviewersAssignedCount, sub.ReviewsCompletedCount)%">
                                        </div>
                                    </div>
                                    <span class="small text-muted mt-1">
                                        @sub.ReviewsCompletedCount / @sub.ReviewersAssignedCount Completed
                                    </span>
                                </div>
                            </td>
                            <td class="text-muted small">
                                <i class="bi bi-calendar3 me-1"></i> @sub.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary rounded-start" title="View Details"
                                            @onclick='() => Nav.NavigateTo($"/submissions/{sub.Id}")'>
                                        <i class="bi bi-eye"></i>
                                    </button>

                                    @if (sub.Status != "Draft")
                                    {
                                        <button class="btn btn-sm btn-outline-primary" title="Assign Reviewer"
                                                @onclick='() => Nav.NavigateTo($"/submissions/{sub.Id}/assign")'>
                                            <i class="bi bi-person-plus-fill"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .ls-1 {
        letter-spacing: 1px;
    }

    .icon-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .custom-table th {
        padding-top: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f1f5f9;
    }

    .custom-table td {
        padding-top: 1rem;
        padding-bottom: 1rem;
        vertical-align: middle;
    }

    .stats-card {
        transition: transform 0.2s;
    }

        .stats-card:hover {
            transform: translateY(-3px);
        }
</style>

@code {
    // Parent'tan (Dashboard.razor) gelen parametreler
    [Parameter] public string SearchTerm { get; set; } = "";
    [Parameter] public string FilterStatus { get; set; } = "";

    private List<SubmissionStatsModel>? submissions;

    // Filtrelenmiş Liste (SearchTerm ve FilterStatus'a göre dinamik hesaplanır)
    private IEnumerable<SubmissionStatsModel> FilteredSubmissions =>
        submissions?
            .Where(s => (string.IsNullOrEmpty(SearchTerm) || s.Title.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || (s.ReferenceNumber ?? "").Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                        (string.IsNullOrEmpty(FilterStatus) || s.Status == FilterStatus))
            ?? new List<SubmissionStatsModel>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            submissions = await SubmissionsClient.GetEditorSubmissionsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private void ClearFilters()
    {
        // Bu metod sadece lokal state'i temizler, parent state'i etkilemesi için EventCallback gerekir
        // Şimdilik basitçe console log atıyoruz, gerçekte Dashboard'daki inputları temizlemeli.
        Console.WriteLine("Filters cleared");
    }

    private async Task ExportToCsv()
    {
        if (submissions == null || !submissions.Any()) return;

        var builder = new StringBuilder();
        builder.AppendLine("ReferenceNumber,Title,Status,Date");

        foreach (var sub in FilteredSubmissions)
        {
            builder.AppendLine($"{sub.ReferenceNumber},\"{sub.Title}\",{sub.Status},{sub.CreatedAt}");
        }

        // Basit indirme işlemi (JS Interop kullanarak)
        var fileName = $"submissions_export_{DateTime.Now:yyyyMMdd}.csv";
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, builder.ToString());
    }

    // --- Yardımcı Metodlar (Renklendirme vb.) ---
    private string GetStatusBadgeClass(string status) => status switch
    {
        "Draft" => "bg-secondary-subtle text-secondary border border-secondary-subtle",
        "Submitted" => "bg-info-subtle text-info border border-info-subtle",
        "UnderReview" => "bg-warning-subtle text-warning border border-warning-subtle",
        "Accepted" => "bg-success-subtle text-success border border-success-subtle",
        "Rejected" => "bg-danger-subtle text-danger border border-danger-subtle",
        "MinorRevisionRequired" => "bg-primary-subtle text-primary border border-primary-subtle",
        "MajorRevisionRequired" => "bg-primary-subtle text-primary border border-primary-subtle",
        "CameraReadyRequested" => "bg-dark-subtle text-dark border border-dark-subtle",
        _ => "bg-light text-dark border"
    };

    private int GetProgressPercentage(int assigned, int completed)
    {
        if (assigned == 0) return 0;
        return (int)((double)completed / assigned * 100);
    }

    private string GetProgressBarColor(int assigned, int completed)
    {
        if (assigned == 0) return "bg-secondary";
        var pct = GetProgressPercentage(assigned, completed);
        if (pct == 100) return "bg-success";
        if (pct >= 50) return "bg-info";
        return "bg-warning";
    }

    private int GetPendingCount() => submissions?.Count(s => s.Status == "Submitted" || s.Status == "UnderReview") ?? 0;
    private int GetAcceptedCount() => submissions?.Count(s => s.Status == "Accepted") ?? 0;
}