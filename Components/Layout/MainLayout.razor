@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject Jarvis.Web.Services.IAuthService AuthService
@inject Jarvis.Web.Services.UsersClient UsersClient  // <-- Inject Edildiğinden Emin Olun
@inject AuthenticationStateProvider AuthStateProvider
@using Jarvis.Web.Components.Shared // SimpleChatBot için eklendi

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main class="main">
        <!-- TOP BAR -->
        <div class="top-row">
            <AuthorizeView>
                <Authorized>
                    <span class="me-3 d-flex align-items-center text-secondary fw-bold">
                        <!-- Profil Resmi Gösterimi -->
                        @if (!string.IsNullOrEmpty(userProfilePic))
                        {
                                    <img src="@userProfilePic" class="rounded-circle me-2 border" style="width: 36px; height: 36px; object-fit: cover;" />
                        }
                        else
                        {
                                    <i class="bi bi-person-circle me-2 fs-4"></i>
                        }
                        @context.User.Identity?.Name
                    </span>
                    <button class="btn btn-outline-danger btn-sm" @onclick="Logout">
                        <i class="bi bi-box-arrow-right"></i> Sign Out
                    </button>
                </Authorized>
                <NotAuthorized>
                    <a href="login" class="btn btn-primary btn-sm">Sign In</a>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <article class="content">
            @Body
        </article>
    </main>

    <!-- CHATBOT ENTEGRASYONU -->
    <SimpleChatBot />

</div>

@code {
    private string? userProfilePic;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity != null && authState.User.Identity.IsAuthenticated)
        {
            try
            {
                // Kullanıcı giriş yapmışsa profil resmini API'den çek
                var profile = await UsersClient.GetProfileAsync();
                if (profile != null)
                {
                    userProfilePic = profile.ProfilePictureUrl;
                }
            }
            catch
            {
                // Hata olursa (örneğin API kapalıysa) varsayılan ikon kalır, uygulama patlamaz.
            }
        }
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        Navigation.NavigateTo("/login", true);
    }
}